 /*!
 * Validator.js
 * Front-end validation engine.
 *
 * Copyright 2012, Adam Drago, Dan Dombrowski
 * 207 West
 * http://207west.com
 *
 * Date: Fri Decembter 14th 2012
 */
(function(){"use strict";this.Validator=function(e){this.config=e;this.fields=e.fields;this.buttons=e.buttons;this.formAdditions=e.formAdditions;this.defaults={};this.showErrors=e.showErrors||true;this.showMessages=e.showMessages||true;this.messages=e.messages;this.errorLabel=e.errorLabel&&!_.isBlank(e.errorLabel)?e.errorLabel:"<span class='badge badge-important'><i class='icon-exclamation-sign icon-white'></i></span>";this.errorLabelStyles=e.errorLabelStyles||{padding:"1px","margin-left":"5px"};this.initialize()};Validator.prototype={initialize:function(){var e=this;this.fields=_.map(this.fields,function(e){var t=new Validator.Field(e);this.defaults[t.name]=t.$el.val();return t},this);this.buttons=_.map(this.buttons,function(e){return new Validator.Button(e)});setInterval(function(){var t=_.filter(e.fields,function(t,n){return t.$el.val()!=e.defaults[t.name]&&t.$el.data("vField").blurCount>0});_.each(t,function(t){e.check(t)})},1e3);if(this.errorLabel){this.$errorLabel=$(this.errorLabel);if(this.errorLabelStyles){this.$errorLabel.css(this.errorLabelStyles)}this.$errorLabelWrap=$("<span>").addClass("error-label").append(this.$errorLabel);this.errorLabelHtml=this.$errorLabelWrap[0].outerHTML}if(this.showMessages){$("form").on({focus:function(){$(this).closest(".control-group").find(".error-label").tooltip("show")},blur:function(){var t=$(this);e.check(t.data("vField"));t.closest(".control-group").find(".error-label").tooltip("hide");t.data("vField").blurCount++}},".control-group input, .control-group textarea, .control-group select").on({mouseenter:function(){var e=$(this).closest(".control-group");var t=e.find("input, select, textarea").eq(0);if(!t.is(":focus"))$(this).tooltip("show")},mouseleave:function(){var e=$(this).closest(".control-group");var t=e.find("input, select, textarea").eq(0);if(!t.is(":focus"))$(this).tooltip("hide")}},".error-label")}if(this.buttons){_.each(this.buttons,function(t){switch(t.type){case Validator.ButtonType.SUBMIT:t.$el.on("click",function(t){var n=$(this).data("vButton");if(e.run()!==true){n.fail.apply(this);n.always.apply(this);t.preventDefault();return false}else{n.success.apply(this);n.always.apply(this);return!n.async}});break;case Validator.ButtonType.CLEAR:t.$el.on("click",function(t){var n=$(this).data("vButton");e.clear();n.always.apply(this);return false});break;default:vButton.always.apply(this);return false;break}})}},run:function(){var e=[],t=[];_.each(this.fields,function(n){var r=n,i=this.check(r);if(i.passed!==true){e.push(i)}else{t.push(i)}},this);return e.length>0?e:true},form:function(){return Validator.Form(this.fields,this.formAdditions)},check:function(e){if(e&&(e.pretest===undefined||e.pretest()===true)){var t=e.$el.closest(".control-group"),n=t.find(".error-label");for(var r=0;r<e.tests.length;r++){var i,s=e.tests[r];if(_.str.include(s,":")){var o=e.tests[r].split(":");s=o.splice(0,1);i=o}var u=Validator.Tests[s](e,i,this);if(!u){if(this.showErrors){t.addClass("error");if(this.errorLabel&&t.find(".error-label").length==0){e.$label.append(this.errorLabelHtml)}}if(this.showMessages&&this.messages){var n=t.find(".error-label");if(!n.data("tooltip")){n.tooltip({placement:"right",trigger:"manual",title:this.messages[s]})}else{n.data("tooltip").options.title=this.messages[s]}}return new Validator.Result(e,false,s)}else if(u&&s=="creditcard"){}}if(e.customTest!==undefined){var u=e.customTest.test();if(!u){if(this.showErrors){t.addClass("error");if(this.errorLabel&&t.find(".error-label").length==0){e.$label.append(this.errorLabelHtml)}}if(this.showMessages&&this.messages){var n=t.find(".error-label");if(!n.data("tooltip")){n.tooltip({placement:"right",trigger:"manual",title:this.messages[e.customTest.name]})}else{n.data("tooltip").options.title=this.messages[e.customTest.name]}}return new Validator.Result(e,false,e.customTest.name)}}if(this.showErrors){t.removeClass("error");if(this.errorLabel){$(".error-label",t).tooltip("hide").remove()}}}return new Validator.Result(e,true)},reset:function(){$(".control-group.error").removeClass("error");$(".error-label").remove()},clear:function(){_.each(this.fields,function(e){var t=e.$el.attr("type");if(t=="radio"||t=="checkbox"){e.$el.prop("checked",false)}else{e.$el.val(this.defaults[e.name])}},this);this.reset()}};Validator.Tests={required:function(e,t){if(!t){return!_.isBlank(e.$el.val())}else{return e.$el.val()!==""}},number:function(e){return!_.isNaN(+e.$el.val())},length:function(e,t){var n=e.$el.val();if(!_.isBlank(n)){return n.length===_.toNumber(t[0])}else{return true}},min:function(e,t){var n=e.$el.val();if(!_.isBlank(n)){return n.length>=_.toNumber(t[0])}else{return true}},max:function(e,t){return e.$el.val().length<=_.toNumber(t[0])},email:function(e){var t=e.$el.val();if(!_.isBlank(t)){return/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(t)}else{return true}},"phone-us":function(e){var t=e.$el.val();if(!_.isBlank(t)){return/^(?:\+?1[-. ]?)?\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(t)}else{return true}},"zip-us":function(e){var t=e.$el.val();if(!_.isBlank(t)){return/^\d{5}(-\d{4})?$/.test(e.$el.val())}else{return true}},"zip-ca":function(e){var t=e.$el.val();if(!_.isBlank(t)){return/^[ABCEGHJKLMNPRSTVXY]{1}\d{1}[A-Z]{1} *\d{1}[A-Z]{1}\d{1}$/i.test(t)}else{return true}},"zip-us-ca":function(e){var t=e.$el.val();if(!_.isBlank(t)){return/(^\d{5}(-\d{4})?$)|(^[ABCEGHJKLMNPRSTVXY]{1}\d{1}[A-Z]{1} *\d{1}[A-Z]{1}\d{1}$)/.test(t)}else{return true}},checked:function(e){return e.$el.prop("checked")},"any-checked":function(e){var t=e.$el.attr("name"),n=false;_.each($("[name='"+t+"']"),function(e,t){if($(e).prop("checked"))n=true});return n},values:function(e,t){var n=e.$el.val();if(!_.isBlank(n)){return _.include(t,n)}else{return true}},date:function(e){var t=e.$el.val(),n=_.str.include(t,"/")?t.split("/"):t.split("-");if(!_.isBlank(t)){if(n.length==3){var r=n[0],i=n[1],s=n[2],o=[31,28,31,30,31,30,31,31,30,31,30,31];if(!_.isBlank(r)&&!_.isNaN(+r)&&!_.isBlank(i)&&!_.isNaN(+i)&&!_.isBlank(s)&&!_.isNaN(+s)){if(!(s%4)&&s%100||!(s%400))o[1]=29;return i<=o[r-1]}}return false}else{return true}},time:function(e){var t=e.$el.val().toLowerCase(),n=t.split(":"),r=_.endsWith(t,"am")||_.endsWith(t,"pm")?t.slice(-2):"",i,s;if(!_.isBlank(t)){if(r=="am"||r=="pm"){n[n.length-1]=n[n.length-1].slice(0,n[n.length-1].length-2);i=12;s=1}else{i=23;s=0}if(/^(\d{1,2}):(\d{2})(:\d{2})?([ap]m)?$/.test(t)){for(var o=0;o<n.length;o++){if(o==0){if(!(n[0]>=s&&n[0]<=i)){return false}}if(o==1||o==2){if(!(n[o]>=0&&n[o]<=59)){return false}}}return true}else{return false}}else{return true}},creditcard:function(e){var t=e.$el.val();var n=t.split("");if(!_.isBlank(t)){if(Validator.Tests["number"](e)){for(var r=n.length-2;r>=0;r-=2){n[r]=(n[r]*2).toString().split("")}n=_.flatten(n);if(!(_.reduce(n,function(e,t){return e+ +t},0)%10)){var i=+t.slice(0,2),s=+t.slice(0,1),o=+t.slice(0,4);var u="";if(i>=51&&i<=55&&t.length==16){u="mastercard"}else if((i==34||i==37)&&t.length==15){u="amex"}else if(s==4&&(t.length==13||t.length==16)){u="visa"}else if(o==6011&&t.length==16){u="discover"}return u}}return false}else{return true}}};Validator.Field=function(e){this.name=e.name;this.el=e.$el&&!e.el?e.$el[0]:e.el;this.$el=e.el&&!e.$el?$(e.el):e.$el;this.$els=this.$el.length>1?this.$el:null;this.tests=e.tests!==undefined?e.tests.split(", "):"";this.pretest=e.pretest;this.customTest=e.customTest;this.blurCount=0;this.label=e.$label&&!e.label?e.$label[0]:e.label;this.$label=e.label&&!e.$label?$(e.label):e.$label;if(!this.$label){this.$label=this.$el.closest(".control-group").find("label").eq(0)}this.$el.data("vField",this);return this};Validator.Button=function(e){this.type=e.type;this.async=e.async||false;this.el=e.$el&&!e.el?e.$el[0]:e.el;this.$el=e.el&&!e.$el?$(e.el):e.$el;this.success=e.success||function(){};this.fail=e.fail||function(){};this.always=e.always||function(){};this.$el.data("vButton",this);return this};Validator.ButtonType={SUBMIT:"submit",CLEAR:"clear"};Validator.Result=function(e,t,n){this.field=e;this.passed=t;this.failedTest=n};Validator.Form=function(e,t){var n={};_.each(e,function(e){if(!e.$els){var t=e.$el.attr("type");if(t=="radio"||t=="checkbox"){n[e.name]=e.$el.prop("checked")}else{n[e.name]=e.$el.val()}}else{n[e.name]=_.map(e.$els,function(e){var t=$(e),n=t.attr("type");if(n=="radio"||n=="checkbox"){return t.prop("checked")}else{return t.val()}})}});var r={};if(t!==undefined){_.each(t,function(e,t){if(_.isFunction(e)){r[t]=e()}else{r[t]=e}});_.extend(n,r)}return n}}).call(this)