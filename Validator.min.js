 /*!
 * Validator.js
 * Front-end validation engine.
 *
 * Copyright 2012, Adam Drago
 * 12:34 MicroTechnologies
 * http://12:34micro.com
 *
 * Date: Wed September 5th 2012
 */
(function(){"use strict";this.Validator=function(a){this.config=a;this.fields=a.fields;this.buttons=a.buttons;this.formAdditions=a.formAdditions;this.defaults={};this.showErrors=a.showErrors||true;this.showMessages=a.showMessages||true;this.messages=a.messages;this.errorLabel=a.errorLabel&&!_.isBlank(a.errorLabel)?a.errorLabel:"<span class='badge badge-important'><i class='icon-exclamation-sign icon-white'></i></span>";this.errorLabelStyles=a.errorLabelStyles||{padding:"1px","margin-left":"5px"};this.initialize()};Validator.prototype={initialize:function(){var a=this;this.fields=_.map(this.fields,function(a){var b=new Validator.Field(a);this.defaults[b.name]=b.$el.val();return b},this);this.buttons=_.map(this.buttons,function(a){return new Validator.Button(a)});setInterval(function(){var b=_.filter(a.fields,function(b,c){return b.$el.val()!=a.defaults[b.name]&&b.$el.data("vField").blurCount>0});_.each(b,function(b){a.check(b)})},1e3);if(this.errorLabel){this.$errorLabel=$(this.errorLabel);if(this.errorLabelStyles){this.$errorLabel.css(this.errorLabelStyles)}this.$errorLabelWrap=$("<span>").addClass("error-label").append(this.$errorLabel);this.errorLabelHtml=this.$errorLabelWrap[0].outerHTML}if(this.showMessages){$("form").on({focus:function(){$(this).closest(".control-group").find(".error-label").tooltip("show")},blur:function(){var b=$(this);a.check(b.data("vField"));b.closest(".control-group").find(".error-label").tooltip("hide");b.data("vField").blurCount++}},".control-group input, .control-group textarea, .control-group select").on({mouseenter:function(){var a=$(this).closest(".control-group");var b=a.find("input, select, textarea").eq(0);if(!b.is(":focus"))$(this).tooltip("show")},mouseleave:function(){var a=$(this).closest(".control-group");var b=a.find("input, select, textarea").eq(0);if(!b.is(":focus"))$(this).tooltip("hide")}},".error-label")}if(this.buttons){_.each(this.buttons,function(b){switch(b.type){case Validator.ButtonType.SUBMIT:b.$el.on("click",function(b){var c=$(this).data("vButton");if(a.run()!==true){c.fail.apply(this);c.always.apply(this);b.preventDefault();return false}else{c.success.apply(this);c.always.apply(this);return!c.async}});break;case Validator.ButtonType.CLEAR:b.$el.on("click",function(b){var c=$(this).data("vButton");a.clear();c.always.apply(this);return false});break;default:vButton.always.apply(this);return false;break}})}},run:function(){var a=[],b=[];_.each(this.fields,function(c){var d=c,e=this.check(d);if(e.passed!==true){a.push(e)}else{b.push(e)}},this);return a.length>0?a:true},form:function(){return Validator.Form(this.fields,this.formAdditions)},check:function(a){if(a&&(a.pretest===undefined||a.pretest()===true)){var b=a.$el.closest(".control-group"),c=b.find(".error-label");for(var d=0;d<a.tests.length;d++){var e,f=a.tests[d];if(_.str.include(f,":")){var g=a.tests[d].split(":");f=g.splice(0,1);e=g}var h=Validator.Tests[f](a,e,this);if(!h){if(this.showErrors){b.addClass("error");if(this.errorLabel&&b.find(".error-label").length==0){a.$label.append(this.errorLabelHtml)}}if(this.showMessages&&this.messages){var c=b.find(".error-label");if(!c.data("tooltip")){c.tooltip({placement:"right",trigger:"manual",title:this.messages[f]})}else{c.data("tooltip").options.title=this.messages[f]}}return new Validator.Result(a,false,f)}else if(h&&f=="creditcard"){}}if(this.showErrors){b.removeClass("error");if(this.errorLabel){$(".error-label",b).tooltip("hide").remove()}}}return new Validator.Result(a,true)},reset:function(){$(".control-group.error").removeClass("error");$(".error-label").remove()},clear:function(){_.each(this.fields,function(a){var b=a.$el.attr("type");if(b=="radio"||b=="checkbox"){a.$el.prop("checked",false)}else{a.$el.val(this.defaults[a.name])}},this);this.reset()}};Validator.Tests={required:function(a,b){if(!b){return!_.isBlank(a.$el.val())}else{return a.$el.val()!==""}},number:function(a){return!_.isNaN(+a.$el.val())},length:function(a,b){var c=a.$el.val();if(!_.isBlank(c)){return c.length===_.toNumber(b[0])}else{return true}},min:function(a,b){var c=a.$el.val();if(!_.isBlank(c)){return c.length>=_.toNumber(b[0])}else{return true}},max:function(a,b){return a.$el.val().length<=_.toNumber(b[0])},email:function(a){var b=a.$el.val();if(!_.isBlank(b)){return/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(b)}else{return true}},"phone-us":function(a){var b=a.$el.val();if(!_.isBlank(b)){return/^(?:\+?1[-. ]?)?\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(b)}else{return true}},"zip-us":function(a){var b=a.$el.val();if(!_.isBlank(b)){return/^\d{5}(-\d{4})?$/.test(a.$el.val())}else{return true}},"zip-ca":function(a){var b=a.$el.val();if(!_.isBlank(b)){return/^[ABCEGHJKLMNPRSTVXY]{1}\d{1}[A-Z]{1} *\d{1}[A-Z]{1}\d{1}$/i.test(b)}else{return true}},"zip-us-ca":function(a){var b=a.$el.val();if(!_.isBlank(b)){return/(^\d{5}(-\d{4})?$)|(^[ABCEGHJKLMNPRSTVXY]{1}\d{1}[A-Z]{1} *\d{1}[A-Z]{1}\d{1}$)/.test(b)}else{return true}},checked:function(a){return a.$el.prop("checked")},"any-checked":function(a){var b=a.$el.attr("name"),c=false;_.each($("[name='"+b+"']"),function(a,b){if($(a).prop("checked"))c=true});return c},values:function(a,b){var c=a.$el.val();if(!_.isBlank(c)){return _.include(b,c)}else{return true}},date:function(a){var b=a.$el.val(),c=_.str.include(b,"/")?b.split("/"):b.split("-");if(!_.isBlank(b)){if(c.length==3){var d=c[0],e=c[1],f=c[2],g=[31,28,31,30,31,30,31,31,30,31,30,31];if(!_.isBlank(d)&&!_.isNaN(+d)&&!_.isBlank(e)&&!_.isNaN(+e)&&!_.isBlank(f)&&!_.isNaN(+f)){if(!(f%4)&&f%100||!(f%400))g[1]=29;return e<=g[d-1]}}return false}else{return true}},time:function(a){var b=a.$el.val().toLowerCase(),c=b.split(":"),d=_.endsWith(b,"am")||_.endsWith(b,"pm")?b.slice(-2):"",e,f;if(!_.isBlank(b)){if(d=="am"||d=="pm"){c[c.length-1]=c[c.length-1].slice(0,c[c.length-1].length-2);e=12;f=1}else{e=23;f=0}if(/^(\d{1,2}):(\d{2})(:\d{2})?([ap]m)?$/.test(b)){for(var g=0;g<c.length;g++){if(g==0){if(!(c[0]>=f&&c[0]<=e)){return false}}if(g==1||g==2){if(!(c[g]>=0&&c[g]<=59)){return false}}}return true}else{return false}}else{return true}},creditcard:function(a){var b=a.$el.val();var c=b.split("");if(!_.isBlank(b)){if(Validator.Tests["number"](a)){for(var d=c.length-2;d>=0;d-=2){c[d]=(c[d]*2).toString().split("")}c=_.flatten(c);if(!(_.reduce(c,function(a,b){return a+ +b},0)%10)){var e=+b.slice(0,2),f=+b.slice(0,1),g=+b.slice(0,4);var h="";if(e>=51&&e<=55&&b.length==16){h="mastercard"}else if((e==34||e==37)&&b.length==15){h="amex"}else if(f==4&&(b.length==13||b.length==16)){h="visa"}else if(g==6011&&b.length==16){h="discover"}return h}}return false}else{return true}}};Validator.Field=function(a){this.name=a.name;this.el=a.$el&&!a.el?a.$el[0]:a.el;this.$el=a.el&&!a.$el?$(a.el):a.$el;this.$els=this.$el.length>1?this.$el:null;this.tests=a.tests!==undefined?a.tests.split(", "):"";this.pretest=a.pretest;this.blurCount=0;this.label=a.$label&&!a.label?a.$label[0]:a.label;this.$label=a.label&&!a.$label?$(a.label):a.$label;if(!this.$label){this.$label=this.$el.closest(".control-group").find("label").eq(0)}this.$el.data("vField",this);return this};Validator.Button=function(a){this.type=a.type;this.async=a.async||false;this.el=a.$el&&!a.el?a.$el[0]:a.el;this.$el=a.el&&!a.$el?$(a.el):a.$el;this.success=a.success||function(){};this.fail=a.fail||function(){};this.always=a.always||function(){};this.$el.data("vButton",this);return this};Validator.ButtonType={SUBMIT:"submit",CLEAR:"clear"};Validator.Result=function(a,b,c){this.field=a;this.passed=b;this.failedTest=c};Validator.Form=function(a,b){var c={};_.each(a,function(a){if(!a.$els){var b=a.$el.attr("type");if(b=="radio"||b=="checkbox"){c[a.name]=a.$el.prop("checked")}else{c[a.name]=a.$el.val()}}else{c[a.name]=_.map(a.$els,function(a){var b=$(a),c=b.attr("type");if(c=="radio"||c=="checkbox"){return b.prop("checked")}else{return b.val()}})}});var d={};if(b!==undefined){_.each(b,function(a,b){if(_.isFunction(a)){d[b]=a()}else{d[b]=a}});_.extend(c,d)}return c}}).call(this)